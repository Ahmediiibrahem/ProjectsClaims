<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cash Control Dashboard – مطالبات المشاريع</title>
  <style>
    :root{
      --bg:#ffffff;
      --muted:#666;
      --border:#eee;
      --shadow:0 2px 14px rgba(0,0,0,.06);
      --card:#fff;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Tahoma, Arial; margin: 22px; background:var(--bg); color:#111; }
    h1 { margin: 0 0 10px; font-size: 22px; }
    .muted { color:var(--muted); font-size:13px; }
    .grid { display:grid; gap:12px; }
    .grid.kpi { grid-template-columns: repeat(3, minmax(220px, 1fr)); }
    @media (max-width: 900px){ .grid.kpi { grid-template-columns: 1fr; } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow: var(--shadow); }
    .kpi .value { font-size: 22px; font-weight: 700; margin-top: 6px; }
    .small { font-size:12px; color:var(--muted); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, button { padding:10px 12px; border:1px solid #ccc; border-radius:12px; font-size:14px; background:#fff; }
    label { display:flex; gap:8px; align-items:center; }
    button { cursor:pointer; }
    button:hover { background:#fafafa; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:10px; border-bottom:1px solid var(--border); text-align:right; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; }
    .table-wrap { overflow:auto; max-height: 70vh; border:1px solid var(--border); border-radius:14px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>

  <h1>Cash Control Dashboard – مطالبات المشاريع</h1>

  <!-- KPIs -->
  <div class="grid kpi">
    <div class="card kpi">
      <div class="muted">إجمالي المطالبات</div>
      <div class="value" id="kpi_total">—</div>
      <div class="small" id="kpi_count">—</div>
    </div>

    <div class="card kpi">
      <div class="muted">إجمالي المنصرف</div>
      <div class="value" id="kpi_paid">—</div>
      <div class="small" id="kpi_paid_count">—</div>
    </div>

    <div class="card kpi">
      <div class="muted">إجمالي المتبقي</div>
      <div class="value" id="kpi_remaining">—</div>
      <div class="small" id="kpi_remaining_count">—</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card" style="margin-top:12px;">
    <div class="row">
      <label>القطاع:
        <select id="sector"></select>
      </label>

      <label>المشروع:
        <select id="project"></select>
      </label>

      <label>بند الحسابات:
        <select id="account_item"></select>
      </label>

      <label>الحالة:
        <select id="status"></select>
      </label>

      <label>نوع التاريخ:
        <select id="date_type">
          <option value="source_request_date">تاريخ الطلب (من المشروع)</option>
          <option value="payment_request_date">تاريخ طلب الصرف</option>
        </select>
      </label>

      <label>من:
        <input id="date_from" type="date" />
      </label>

      <label>إلى:
        <input id="date_to" type="date" />
      </label>

      <button id="clearBtn" title="مسح الفلاتر">مسح</button>
      <button id="exportBtn" title="تصدير النتائج الحالية CSV">تصدير CSV</button>
    </div>

    <div class="small" style="margin-top:10px;">
      المعروض الآن: <span id="meta">—</span>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="margin-top:12px;">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>رقم الطلب</th>
            <th>الكود</th>
            <th>المورد</th>
            <th>المبلغ</th>
            <th>المنصرف</th>
            <th>الملغي</th>
            <th>المتبقي</th>
            <th>بند الحسابات</th>
            <th>المشروع</th>
            <th>تاريخ الطلب (من المشروع)</th>
            <th>تاريخ طلب الصرف</th>
            <th>التعميد</th>
            <th>الصرف</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
  // ============================================================
  // Helpers
  // ============================================================
  function toNumber(x){
    if (x === null || x === undefined) return 0;
    const s = String(x).trim();
    if (!s) return 0;
    const cleaned = s.replace(/,/g,'');
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function fmtMoney(n){
    return (n || 0).toLocaleString("en-US", { maximumFractionDigits: 2 });
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function parseDateISO(s){
    const t = String(s || "").trim();
    if (!t) return null;
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(t);
    if (!m) return null;
    const d = new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
    return isNaN(d.getTime()) ? null : d;
  }

  function dateInRange(d, from, to){
    if (!d) return false;
    const t = d.getTime();
    if (from && t < from.getTime()) return false;
    if (to && t > to.getTime()) return false;
    return true;
  }

  // CSV parser بسيط (PoC)
  function parseCSV(text){
    const lines = text.replace(/\r/g,'').split("\n").filter(l => l.trim().length);
    if (!lines.length) return [];
    const headers = lines[0].split(",").map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h,i) => obj[h] = (cols[i] ?? "").trim());
      return obj;
    });
  }

  // ============================================================
  // Header mapping (يدعم إنجليزي + بدائل عربي)
  // ============================================================
  const headerMap = {
    sector: "sector",
    project: "project",
    account_item: "account_item",
    status: "status",
    request_id: "request_id",
    code: "code",
    vendor: "vendor",
    amount_total: "amount_total",
    amount_paid: "amount_paid",
    amount_canceled: "amount_canceled",
    amount_remaining: "amount_remaining",
    source_request_date: "source_request_date",
    payment_request_date: "payment_request_date",
    approval_date: "approval_date",
    payment_date: "payment_date",

    "القطاع": "sector",
    "قطاع": "sector",
    "المشروع": "project",
    " المشروع": "project",
    "بند الحسابات": "account_item",
    "الحالة": "status",
    "رقم الطلب": "request_id",
    "الكود": "code",
    "المورد/ المقاول": "vendor",
    "المورد/المقاول": "vendor",
    "المورد": "vendor",
    "المبلغ": "amount_total",
    "المنصرف": "amount_paid",
    "ملغي": "amount_canceled",
    "الملغي": "amount_canceled",
    "المتبقي": "amount_remaining",
    "تاريخ الطلب (المصدر)": "source_request_date",
    "تاريخ الطلب من المشروع": "source_request_date",
    "تاريخ الطلب (الصرف)": "payment_request_date",
    "تاريخ طلب الصرف": "payment_request_date",
    "تاريخ التعميد": "approval_date",
    "تاريخ الصرف": "payment_date"
  };

  function normalizeRow(raw){
    const x = {};
    for (const [k,v] of Object.entries(raw)){
      const key = headerMap[k] || k;
      x[key] = v;
    }

    const vendor = (x.vendor || "").trim();

    return {
      sector: (x.sector || "").trim(),
      project: (x.project || "").trim(),
      account_item: (x.account_item || "").trim(),
      status: (x.status || "").trim(),

      request_id: (x.request_id || "").trim(),
      code: (x.code || "").trim(),
      vendor,

      amount_total: toNumber(x.amount_total),
      amount_paid: toNumber(x.amount_paid),
      amount_canceled: toNumber(x.amount_canceled),
      amount_remaining: toNumber(x.amount_remaining),

      source_request_date: (x.source_request_date || "").trim(),
      payment_request_date: (x.payment_request_date || "").trim(),
      approval_date: (x.approval_date || "").trim(),
      payment_date: (x.payment_date || "").trim(),

      _srcDate: parseDateISO((x.source_request_date || "").trim()),
      _payReqDate: parseDateISO((x.payment_request_date || "").trim())
    };
  }

  // ============================================================
  // Duplicate detection (hidden for now)
  // ============================================================
  function detectDuplicates(items){
    const byRequestId = new Map();
    items.forEach((x, idx) => {
      const rid = x.request_id || "";
      if (rid){
        if (!byRequestId.has(rid)) byRequestId.set(rid, []);
        byRequestId.get(rid).push(idx);
      }
    });

    const flags = new Array(items.length).fill(false);
    for (const [rid, idxs] of byRequestId.entries()){
      if (rid && idxs.length > 1){
        idxs.forEach(i => flags[i] = true);
      }
    }
    return items.map((x,i)=> ({...x, _isDup: flags[i]}));
  }

  // ============================================================
  // State + Cascading dropdowns (Sector -> Project)
  // ============================================================
  let data = [];
  let projectsBySector = new Map(); // sector -> Set(project)
  let allProjects = []; // for sector=all case

  function setSelectOptions(selectId, values, keepValue){
    const sel = document.getElementById(selectId);
    const current = keepValue ? sel.value : "";
    const uniq = Array.from(new Set(values.filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    sel.innerHTML =
      `<option value="">الكل</option>` +
      uniq.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");

    if (keepValue && current && uniq.includes(current)){
      sel.value = current;
    } else {
      sel.value = "";
    }
  }

  function rebuildProjectDropdownForSector(){
    const sector = document.getElementById("sector").value.trim();
    const projects = sector
      ? Array.from(projectsBySector.get(sector) || [])
      : allProjects;

    setSelectOptions("project", projects, true);
  }

  function buildGlobalDropdowns(){
    setSelectOptions("sector", data.map(x => x.sector), false);
    setSelectOptions("account_item", data.map(x => x.account_item), false);
    setSelectOptions("status", data.map(x => x.status), false);
    setSelectOptions("project", allProjects, false);
  }

  function getFilterDates(){
    const fromStr = document.getElementById("date_from").value;
    const toStr   = document.getElementById("date_to").value;

    const from = fromStr ? parseDateISO(fromStr) : null;
    const to   = toStr ? parseDateISO(toStr) : null;

    let toInc = null;
    if (to){
      toInc = new Date(to.getTime() + (24*60*60*1000) - 1);
    }
    return { from, to: toInc };
  }

  // ============================================================
  // APPLY FILTERS
  // **NEW RULE**: only include rows where vendor is NOT empty
  // ============================================================
  function applyFilters(items){
    const sector = document.getElementById("sector").value.trim();
    const project = document.getElementById("project").value.trim();
    const accountItem = document.getElementById("account_item").value.trim();
    const status = document.getElementById("status").value.trim();

    const dateType = document.getElementById("date_type").value;
    const { from, to } = getFilterDates();

    return items.filter(x => {
      // ✅ شرط “المطالبة الفعلية”
      if (!x.vendor) return false;

      if (sector && x.sector !== sector) return false;
      if (project && x.project !== project) return false;
      if (accountItem && x.account_item !== accountItem) return false;
      if (status && x.status !== status) return false;

      if (from || to){
        const d = (dateType === "payment_request_date") ? x._payReqDate : x._srcDate;
        if (!dateInRange(d, from, to)) return false;
      }
      return true;
    });
  }

  function computeKPIs(items){
    const total = items.reduce((a,x)=>a + x.amount_total, 0);
    const paid  = items.reduce((a,x)=>a + x.amount_paid, 0);
    const rem   = items.reduce((a,x)=>a + x.amount_remaining, 0);
    return { total, paid, rem, count: items.length };
  }

  function renderKPIs(k){
    document.getElementById("kpi_total").textContent = fmtMoney(k.total);
    document.getElementById("kpi_paid").textContent = fmtMoney(k.paid);
    document.getElementById("kpi_remaining").textContent = fmtMoney(k.rem);

    document.getElementById("kpi_count").textContent = `عدد المطالبات: ${k.count}`;
    document.getElementById("kpi_paid_count").textContent = `عدد السجلات: ${k.count}`;
    document.getElementById("kpi_remaining_count").textContent = `عدد السجلات: ${k.count}`;
  }

  function renderTable(items){
    const dateType = document.getElementById("date_type").value;
    const sorted = [...items].sort((a,b)=>{
      const da = (dateType === "payment_request_date") ? a._payReqDate : a._srcDate;
      const db = (dateType === "payment_request_date") ? b._payReqDate : b._srcDate;
      const ta = da ? da.getTime() : -Infinity;
      const tb = db ? db.getTime() : -Infinity;
      return tb - ta;
    });

    const tbody = document.getElementById("rows");
    tbody.innerHTML = sorted.map(x => `
      <tr>
        <td class="mono">${escapeHtml(x.request_id)}</td>
        <td class="mono">${escapeHtml(x.code)}</td>
        <td>${escapeHtml(x.vendor)}</td>
        <td>${fmtMoney(x.amount_total)}</td>
        <td>${fmtMoney(x.amount_paid)}</td>
        <td>${fmtMoney(x.amount_canceled)}</td>
        <td><b>${fmtMoney(x.amount_remaining)}</b></td>
        <td>${escapeHtml(x.account_item)}</td>
        <td>${escapeHtml(x.project)}</td>
        <td class="mono">${escapeHtml(x.source_request_date)}</td>
        <td class="mono">${escapeHtml(x.payment_request_date)}</td>
        <td class="mono">${escapeHtml(x.approval_date)}</td>
        <td class="mono">${escapeHtml(x.payment_date)}</td>
      </tr>
    `).join("");
  }

  function render(){
    const withDup = detectDuplicates(data); // hidden
    const filtered = applyFilters(withDup);
    const kpis = computeKPIs(filtered);

    document.getElementById("meta").textContent =
      `${filtered.length} سجل | إجمالي: ${fmtMoney(kpis.total)} | منصرف: ${fmtMoney(kpis.paid)} | متبقي: ${fmtMoney(kpis.rem)}`;

    renderKPIs(kpis);
    renderTable(filtered);
  }

  // ============================================================
  // Export (export only rows that pass the SAME filters)
  // ============================================================
  function safeCSV(value){
    const s = String(value ?? "");
    if (/[",\n]/.test(s)){
      return `"${s.replaceAll('"','""')}"`;
    }
    return s;
  }

  function exportCurrentCSV(){
    const withDup = detectDuplicates(data);
    const filtered = applyFilters(withDup);

    const headers = [
      "sector","project","account_item","status",
      "request_id","code","vendor",
      "amount_total","amount_paid","amount_canceled","amount_remaining",
      "source_request_date","payment_request_date","approval_date","payment_date"
    ];

    const lines = [headers.join(",")];
    filtered.forEach(x => {
      lines.push([
        safeCSV(x.sector),
        safeCSV(x.project),
        safeCSV(x.account_item),
        safeCSV(x.status),
        safeCSV(x.request_id),
        safeCSV(x.code),
        safeCSV(x.vendor),
        x.amount_total,
        x.amount_paid,
        x.amount_canceled,
        x.amount_remaining,
        safeCSV(x.source_request_date),
        safeCSV(x.payment_request_date),
        safeCSV(x.approval_date),
        safeCSV(x.payment_date)
      ].join(","));
    });

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "export_filtered.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearFilters(){
    document.getElementById("sector").value = "";
    rebuildProjectDropdownForSector();
    document.getElementById("account_item").value = "";
    document.getElementById("status").value = "";
    document.getElementById("date_type").value = "source_request_date";
    document.getElementById("date_from").value = "";
    document.getElementById("date_to").value = "";
    render();
  }

  async function init(){
    const res = await fetch("./data.csv", { cache: "no-store" });
    if (!res.ok){
      alert("مش قادر أقرأ data.csv — تأكد إنه موجود جنب index.html");
      return;
    }

    const text = await res.text();
    const raw = parseCSV(text);
    data = raw.map(normalizeRow);

    // build sector->projects map (only from rows with vendor? لا، نخليه على كل الداتا عادي)
    projectsBySector = new Map();
    data.forEach(x => {
      if (!x.project) return;
      const sec = x.sector || "(بدون قطاع)";
      if (!projectsBySector.has(sec)) projectsBySector.set(sec, new Set());
      projectsBySector.get(sec).add(x.project);
    });

    allProjects = Array.from(new Set(data.map(x => x.project).filter(Boolean))).sort((a,b)=>a.localeCompare(b));

    buildGlobalDropdowns();

    document.getElementById("sector").addEventListener("change", () => {
      rebuildProjectDropdownForSector();
      render();
    });

    ["project","account_item","status","date_type","date_from","date_to"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("change", render);
      el.addEventListener("input", render);
    });

    document.getElementById("exportBtn").addEventListener("click", exportCurrentCSV);
    document.getElementById("clearBtn").addEventListener("click", clearFilters);

    render();
  }

  init();
</script>
</body>
</html>
